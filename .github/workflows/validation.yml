name: Validate Production Pull Request

on:
  pull_request:
    branches:
      - main
    paths:
      - 'force-app/**'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Salesforce CLI
        run: npm install --global @salesforce/cli

      - name: Install Salesforce Scanner Plugin
        run: sf plugins install @salesforce/sfdx-scanner

      - name: Run SFDX scanner on code
        run: |
          mkdir -p dist/changed-metadata
          # Copy your changed classes to this folder if needed
          cp -r force-app/main/default/classes/* dist/changed-metadata/
          
          cd dist/changed-metadata
          sf scanner:run \
            --format csv \
            --target './**/*.cls' \
            --category "Design,Best Practices,Performance" \
            --outfile ../ScanResults.csv
          cd ../..

      - name: Upload Salesforce Scanner Report
        uses: actions/upload-artifact@v4
        with:
          name: scanner-report
          path: dist/ScanResults.csv

      - name: Validate on our Org (Dry Run)
        uses: jawills/sf-deploy@v1.0
        with:
          SFDX_AUTH_URL: ${{ secrets.SFDX_AUTH_URL }}
          DRY_RUN: true
          TEST_LEVEL: NoTestRun
